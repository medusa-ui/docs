"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[968],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=d(n),h=i,m=c["".concat(l,".").concat(h)]||c[h]||p[h]||r;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:i,o[1]=s;for(var d=2;d<r;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2952:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=n(7462),i=(n(7294),n(3905));const r={sidebar_position:3},o="Components",s={unversionedId:"internals/components",id:"internals/components",title:"Components",description:"Attributes",source:"@site/docs/internals/components.md",sourceDirName:"internals",slug:"/internals/components",permalink:"/documentation/docs/internals/components",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Internal flow of rendering",permalink:"/documentation/docs/internals/medusa-flow"},next:{title:"Hydra flow",permalink:"/documentation/docs/internals/hydra-flow"}},l={},d=[{value:'<a name="dom-changes"></a> Attributes',id:"-attributes",level:3},{value:'<a name="req-handler"></a> Request handler',id:"-request-handler",level:3},{value:'<a name="session"></a> Session',id:"-session",level:3},{value:'<a name="renderer"></a> Renderer',id:"-renderer",level:3},{value:'<a name="action-handler"></a> Action Handler',id:"-action-handler",level:3},{value:'<a name="diff-engine"></a> Diff Engine',id:"-diff-engine",level:3}],u={toc:d};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"components"},"Components"),(0,i.kt)("h3",{id:"-attributes"},(0,i.kt)("a",{name:"dom-changes"})," Attributes"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"io.medusa.medusa.core.domchanges")),(0,i.kt)("p",null,"Key/value pairs that get used as the model attributes during rendering."),(0,i.kt)("h3",{id:"-request-handler"},(0,i.kt)("a",{name:"req-handler"})," Request handler"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"io.getmedusa.medusa.core.router.request")),(0,i.kt)("p",null,"The initial request only resolves if it matches a route set up initially in the RouteSetup class. This is a class that connects the routes loaded during at-startup initialization with a process to handle its rendering."),(0,i.kt)("p",null,"It then proceeds onto the RequestStreamHandler - the goal of which is to trigger the actual response and rendering of HTML.\nThis is one of two implementations of IRequestStreamHandler: The distinction lies between whether an actual Spring Security context is added or not."),(0,i.kt)("p",null,"Regardless, a session is built up and associated with the request. The actual rendering itself is handled by the renderer."),(0,i.kt)("h3",{id:"-session"},(0,i.kt)("a",{name:"session"})," Session"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"io.getmedusa.medusa.core.session")),(0,i.kt)("p",null,"A session refers to a loaded page with an active open RSocket channel."),(0,i.kt)("p",null,"A session contains:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Which template was rendered"),(0,i.kt)("li",{parentName:"ul"},"Which controller was used"),(0,i.kt)("li",{parentName:"ul"},"Last rendered HTML"),(0,i.kt)("li",{parentName:"ul"},"Last used parameters to render"),(0,i.kt)("li",{parentName:"ul"},"Tags: for bi-directionality")),(0,i.kt)("p",null,"A session is stored in either local memory (when set up as a single instance) or redis (when set up as a multi-instance cluster)."),(0,i.kt)("h3",{id:"-renderer"},(0,i.kt)("a",{name:"renderer"})," Renderer"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"io.getmedusa.medusa.core.render")),(0,i.kt)("p",null,"Uses Thymeleaf to render the page with the provided Session's attributes.\nWe use Thymeleaf for its rendering speed, and it's ability to be extended with new tags."),(0,i.kt)("p",null,"While most Medusa functionality is handled through Thymeleaf tags, the processing of these is not Reactive; thus something like Fragments is something that is resolved before the HTML is sent to "),(0,i.kt)("p",null,"After the render, websocket.js is injected and some JS variables are initialized."),(0,i.kt)("h3",{id:"-action-handler"},(0,i.kt)("a",{name:"action-handler"})," Action Handler"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"io.getmedusa.medusa.core.router.action")),(0,i.kt)("p",null,"The Action Handler is a service that can take an operation call from JS (for example ",(0,i.kt)("inlineCode",{parentName:"p"},"doThisAction(1, 'example')"),") and resolves it to an actual controller method. It does this via Spring's Expression language interpreter.\nThe result is a set of Attributes, which get merged into the Session."),(0,i.kt)("h3",{id:"-diff-engine"},(0,i.kt)("a",{name:"diff-engine"})," Diff Engine"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"io.getmedusa.medusa.core.diffengine")),(0,i.kt)("p",null,"The diff engine takes two HTMLs and calculates the difference between them. The differences are exposed as a combination of xpath pointers and before/after HTML.\nInternally it uses XMLUnit's DiffEngine for this difference calculation. More on XMLUnit here: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/xmlunit/user-guide/wiki/Comparing-XML#monitoring-the-comparison-process"},"https://github.com/xmlunit/user-guide/wiki/Comparing-XML#monitoring-the-comparison-process")),(0,i.kt)("p",null,"Diffs generated get mapped onto either an ADDITION, REMOVAL or EDIT POJO called JSReadyDiff. This corresponds with how the JS should interpret it."),(0,i.kt)("p",null,'Addition: Appends a row after the provided XPath. That means that the xpath always points to the previous sibling. If no previous sibling exists, the pointer is the parent entry with ::first. At that point the parent entry gets looked up and the entry added as a child.\nRemoval: XPath is found and removed\nEdit: Morphdom is executed on the found XPath. This is essentially the same as element.innerHTML = "", except it is capable of dealing with nuances around caret positions, etc.'),(0,i.kt)("p",null,"The core concept is thus quite simple. Of course, there are nuances:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"As you change elements, the XPaths can change. For example, if you have 3 list items and you have a pointer to change the 3rd one, but then also a removal of the 2nd one, then the order of execution would start to matter. As such, we do not send a diff one at a time, but we send it in batches (ie 1 batch per action, which can contain multiple diffs). The batch interpretation then goes in 2 phases. Phase 1: Iterate over all diffs and resolve their xpaths to an element. Phase 2: Execute them based on the already looked up elements."),(0,i.kt)("li",{parentName:"ul"},"This comes with another problem, if the addition diff refers to the previous element, and there are multiple elements added in the same change, there can be inter-dependencies. For example, if you have a list with 1 item and a change causes 2 items to be added to the list, the first element will have a previous element of an existing item, but the second item will point to the newly created item. As such, specifically with additions, we allow for a last-chance lookup at execution time in case the element was not found during initial lookup in phase 1."),(0,i.kt)("li",{parentName:"ul"},"Not all diffs are represented (yet). For example, we don't care if the child node list length is different - because we only care about the specific nodes.")))}c.isMDXComponent=!0}}]);